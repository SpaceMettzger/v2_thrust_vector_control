import rocket_physics as rp
from rocket import Rocket
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
from matplotlib.widgets import Slider


# Initialize Rocket
rocket = Rocket()

# Simulation Parameters
t = 0
time_step = 1  # s
total_time = 500  # s


thrust_vector_waypoints = {0: {"yaw": 0, "pitch": 0},
                           10: {"yaw": 0, "pitch": 90},
                           20: {"yaw": 0, "pitch": 90},
                           30: {"yaw": 0, "pitch": 90},
                           40: {"yaw": 0, "pitch": 90}}

thrust_vector_waypoints = {0: {"yaw": 0, "pitch": 0},
                           10: {"yaw": 90, "pitch": 0},
                           20: {"yaw": 90, "pitch": 0},
                           30: {"yaw": 90, "pitch": 0},
                           40: {"yaw": 90, "pitch": 0}}


# Store trajectory and attitude data
time_values = []
x_positions = []
y_positions = []
z_positions = []

target_pitch, target_yaw = 0, 0

# Run Simulation
while rocket.y_position >= 0:
    rocket.update_flight_time(time_step)

    if t in thrust_vector_waypoints:
        target_yaw = thrust_vector_waypoints[t]["yaw"]
        target_pitch = thrust_vector_waypoints[t]["pitch"]

    rocket.update_thruster_deflection(target_pitch, target_yaw)

    pitch_torque, yaw_torque, roll_torque= rocket.get_torque()

    # Compute angular acceleration (rotation effect)
    rp.calculate_angular_acceleration(rocket,
        pitch_torque, yaw_torque, roll_torque)

    rocket.update_angular_motion(rocket.pitch_acceleration, rocket.yaw_acceleration, rocket.roll_acceleration,
                                 time_step)

    # Compute thrust components in x, y, z
    # thrust_x, thrust_y, thrust_z = thrust.calculate_thrust_vector_components(rocket)
    thrust_x, thrust_y, thrust_z = rocket.calculate_thruster_deflection_transformation()

    # print(thrust_x, thrust_y, thrust_z)

    # Compute acceleration (F = ma)
    acceleration_x, acceleration_y, acceleration_z = rp.calculate_linear_acceleration(
        thrust_x, thrust_y, thrust_z, rocket)

    rocket.update_velocity(acceleration_x, acceleration_y, acceleration_z, time_step)
    rocket.update_position(time_step)

    # Store trajectory data
    time_values.append(t)
    x_positions.append(rocket.x_position)
    y_positions.append(rocket.y_position)
    z_positions.append(rocket.z_position)

    rocket.record_rocket_params()

    # Stop simulation if rocket hits the ground or timeout
    t += time_step
    if t >= total_time:
        break

print("pitch_angles: ", rocket.pitch_angles)
print("pitch_accelerations: ", rocket.pitch_accelerations)
print("pitch_velocities: ", rocket.pitch_velocities)
print("thrust_pitch_angles: ", rocket.thrust_pitch_angles)


# Create Visualization
fig = plt.figure(figsize=(10, 8))
ax_3d = fig.add_subplot(211, projection='3d')
trajectory, = ax_3d.plot([], [], [], label="Rocket Trajectory", color="b")
ax_3d.set_xlabel("X (Horizontal Distance, m)")
ax_3d.set_ylabel("Z (Lateral Distance, m)")
ax_3d.set_zlabel("Y (Altitude, m)")
ax_3d.set_title("3D Rocket Trajectory with Thrust Vectoring")
ax_3d.legend()
ax_3d.set_xlim(min(x_positions), max(x_positions))
ax_3d.set_ylim(min(z_positions), max(z_positions))
ax_3d.set_zlim(0, max(y_positions))

# Plot Pitch, Yaw, Roll vs Time
ax_attitude = fig.add_subplot(212)
ax_attitude.set_title("Rocket Attitude Over Time")
ax_attitude.set_xlabel("Time (s)")
ax_attitude.set_ylabel("Angle (degrees)")
ax_attitude.plot(time_values, rocket.pitch_angles, label="Pitch")
ax_attitude.plot(time_values, rocket.yaw_angles, label="Yaw")
ax_attitude.plot(time_values, rocket.roll_angles, label="Roll")
ax_attitude.legend()

# Add Time Slider
ax_slider = plt.axes([0.2, 0.02, 0.65, 0.03])
time_slider = Slider(ax_slider, "Time", 0, len(time_values) - 1, valinit=0, valstep=1)


def update(val):
    t = int(time_slider.val)
    trajectory.set_data(x_positions[:t], z_positions[:t])
    trajectory.set_3d_properties(y_positions[:t])
    fig.canvas.draw_idle()


time_slider.on_changed(update)

plt.show()

# [6.216554084039976, 16.75900232820279, 29.448269761756784, 42.03871889941316, 52.58656016174873, 59.79528607951948, 63.155469506814555, 62.87116563956707, 59.68027326886633, 54.64981039873933, 48.96588288153133, 43.72526100271163, 39.75871194115942, 37.52543801522263, 37.09514225884592, 38.20412924776616, 40.358763450659296, 42.9611448020346, 45.43480384490651, 39.45704636372006, 35.769149651643716, 34.66279047019157, 35.87104784581724, 38.7164521637805, 42.30870731990821, 45.75583975590488, 48.34992917886053, 49.688799634215954, 49.71293340049024, 48.662448229904896, 46.97632041566048, 45.162989805444326, 33.99601712956679, 27.724297141294784, 26.92317446483308, 30.768800365482907, 37.466531703174184, 44.79286414223599, 39.871153983032016, 37.3291485445486, 37.42130014799392, 39.638871974354274, 42.96379502749196, 46.22623869989996, 48.46529619161448, 49.18531852613033, 48.4380298851637, 46.727155366884055, 44.78550654624546, 29.508598485699288, 22.622715800961238, 24.917688656925744, 33.98067912716719, 45.364822770675936, 38.646897025264124, 35.805134804974664, 37.29865362848002, 41.75031124386323, 46.73328912083925, 49.93610389729848, 50.24283211320421, 50.48821468592879, 50.684520744108454, 50.84156559065219, 50.96720146788717, 51.06771016967516, 51.14811713110555, 51.212442700249866, 51.263903155565316, 51.30507151981767, 51.338006211219565, 51.36435396434108, 51.385432166838285, 51.402294728836054, 51.415784778434265, 51.426576818112835, 51.43521044985569, 51.44211735524998, 51.44764287956541, 51.45206329901775, 51.45559963457963, 51.45842870302913, 51.460691957788725, 51.4625025615964, 51.46395104464255, 51.46510983107947, 51.466036860228996, 51.46677848354862, 51.467371782204324, 51.46784642112888, 51.46822613226853, 51.468529901180254, 51.46877291630963, 51.46896732841313, 51.46912285809593, 51.46924728184217, 51.469346820839164, 51.46942645203676, 51.46949015699483, 51.46954112096129, 51.46958189213446, 51.46961450907299, 51.46964060262382, 51.469661477464484, 51.469678177337016, 51.46969153723504, 51.46970222515346, 51.469710775488196, 51.46971761575598, 51.469723087970216, 51.4697274657416, 51.469730967958704, 51.46973376973239, 51.46973601115134, 51.4697378042865, 51.46973923879463, 51.469740386401135, 51.469741304486334, 51.46974203895449, 51.46974262652902, 51.469743096588644, 51.469743472636345, 51.469743773474505, 51.46974401414503, 51.46974420668145, 51.469744360710585, 51.469744483933894, 51.46974458251254, 51.46974466137546, 51.46974472446579, 51.46974477493806, 51.46974481531587, 51.469744847618124, 51.46974487345992, 51.46974489413336, 51.46974491067212, 51.46974492390312, 51.46974493448792, 51.469744942955764, 51.469744949730035, 51.46974495514945, 51.469744959484984, 51.46974496295341, 51.469744965728154, 51.469744967947946, 51.469744969723784, 51.46974497114445, 51.469744972280985, 51.46974497319021, 51.46974497391759, 51.4697449744995, 51.469744974965025, 51.46974497533744, 51.46974497563538, 51.46974497587373, 51.46974497606441, 51.46974497621696, 51.469744976338994, 51.46974497643662, 51.469744976514725, 51.46974497657721, 51.4697449766272, 51.46974497666719, 51.469744976699175, 51.46974497672477, 51.46974497674524, 51.46974497676162, 51.46974497677472, 51.4697449767852, 51.469744976793585, 51.46974497680029, 51.46974497680566, 51.46974497680995, 51.46974497681338, 51.46974497681613, 51.469744976818326, 51.46974497682009, 51.469744976821495, 51.46974497682262, 51.46974497682352, 51.46974497682424, 51.46974497682481, 51.469744976825275, 51.469744976825645, 51.46974497682594, 51.46974497682618, 51.46974497682637, 51.46974497682652, 51.46974497682664, 51.46974497682674, 51.46974497682682, 51.46974497682688, 51.46974497682693, 51.46974497682697, 51.469744976827, 51.46974497682703, 51.46974497682705, 51.469744976827066, 51.46974497682708, 51.46974497682709, 51.469744976827094, 51.4697449768271, 51.46974497682711, 51.469744976827116, 51.469744976827116, 51.469744976827116, 51.469744976827116, 51.469744976827116, 51.469744976827116, 51.469744976827116, 51.469744976827116, 51.469744976827116, 51.469744976827116, 51.469744976827116]
# [3.885346302524985, 9.482090066965268, 15.545797867361406, 21.37349306503058, 26.592753992756354, 31.04037063249556, 34.68520524556322, 37.57518087732339, 39.80010521689414, 41.466380983837375, 42.680894516987344, 43.54173580806007, 44.1337013519612, 44.52691647511065, 40.15388365409776, 38.52528853932501, 38.46587176822185, 39.208479351893594, 40.274249944910856, 41.38219355301658, 42.38296539691038, 43.211392380185806, 43.85317882867999, 44.32220274163224, 44.64560799764573, 39.444568744068334, 37.5945083782298, 37.68467513568979, 38.74902421413353, 40.16726034132548, 41.57351734195064, 42.77970278778773, 43.71457088203829, 44.37752883580958, 44.805408969335694, 38.65103432852494, 36.59193016496392, 36.93430558047774, 38.44759408716887, 40.317459230380315, 42.064934212760484, 43.45887710103462, 44.43485664625308, 45.02738156933837, 37.66049836675824, 35.39207747619563, 36.149297770229545, 38.312719398629646, 40.77797615287599, 42.90699988553644, 44.42749945337878, 45.31575757377964, 36.40707849074596, 33.972321948091846, 35.4136742243159, 38.516512750910174, 41.73160975751168, 44.20515647690029, 45.65936614500012, 46.20014700584749, 46.1273881127898, 46.091008666260954, 46.072818942996534, 46.06372408136432, 46.05917665054822, 46.056902935140165, 46.05576607743614, 46.05519764858413, 46.05491343415812, 46.054771326945115, 46.05470027333861, 46.05466474653536, 46.054646983133736, 46.05463810143292, 46.05463366058252, 46.054631440157316, 46.054630329944715, 46.05462977483841, 46.05462949728526, 46.054629358508684, 46.0546292891204, 46.05462925442625, 46.05462923707918, 46.054629228405645, 46.054629224068876, 46.05462922190049, 46.0546292208163, 46.05462922027421, 46.05462922000316, 46.054629219867635, 46.05462921979987, 46.05462921976599, 46.05462921974905, 46.05462921974058, 46.05462921973635, 46.05462921973423, 46.05462921973317, 46.05462921973264, 46.05462921973238, 46.05462921973224, 46.05462921973218, 46.05462921973214, 46.05462921973213, 46.05462921973212, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114, 46.054629219732114]